# redissyncer introduction

redissyncer是一个用于redis同步的多任务服务端引擎。

## redis实例同步的一般方式及优缺点

常见的Redis数据迁移方式：

* RDB/AOF
* 主从复制
  
### RDB/AOF复制

* 同步机制
利用redis本身的备份/恢复机制，源库备份，目标库恢复。

* 主要流程：

  * 应用停写
  * 源端Redis进行save/bgsave或aofrewrite 保存离线文件，传输离线文件
  * 目标端Redis加载离线文件
  * 应用将读写流量切到目标端Redis。

从上面的流程看出，整个过程中，应用停写的时间比较长，少则10分钟，多则半小时一小时，对业务的服务影响比较大。

* 优点：
  * 操作简单，不需引入redis意外的其他工具链

* 限制条件
  * 业务系统需要较长的停写时间
  * 源和目标库版本需要保持备份文件(rdb/aof)兼容
  * 集群模式节点数和拓扑必须一致

### Replication（主从复制）

* 同步机制
利用redis自身的主从同步功能，目标库作为原库的从库同步数据

* 主要流程：
  * 目标端作为源端的从库开启，等全量数据同步完成，保持增量同步
  * 应用停写
  * 流量灰度切换到目标库

* 优点：
  * 应用停写时间短，不需引入redis意外的其他工具链

* 限制条件：
  * 两端Redis网络可达
  * 两端Redis的的replication协议兼容
  * 集群迁移时两端Redis集群的节点必须一一对应（即分片数和key的划分规则必须一致）

## redissyncer产品特点

* 易部署
* 多任务
* 任务可监控
* 支持断点续传
* 支持rdb/aof导入
* 支持rdb版本不一致时redis实例间数据同步即跨版本数据迁移
* 支持不同节点数量的集群间数据迁移

## 典型案例

### 背景

随着云闪付商城会员数量不断增加，为了留住老会员，同时吸引新会员，优惠券作为主要营销活动，占有不可或缺的地位。
但随着优惠券的不断分发，原有的Redis原生集群方式，已无法满足业务需求。需要将数据迁移到扩展性更好，容量接近无限的银联自研UpRedis集群。

### 场景与挑战

* redis 原生集群到用户定制化集群
* 原生集群版本4.0，upredis基于redis3.2开发rdb版本不兼容
* 秒级业务切换时间
* 数据基数大存量数据200G+
* 源与目标集群节点数量不一致
* 业务数据变动频繁

### 流程架构图

![架构图](images/introduction/architectrue.jpg)

### 迁移过程

* 为每个源集群中的数据节点创建同步任务。
* 任务启动后redissyncer通过sync命令在源redis节点中拉取全量数据，数据到达redissyncer后，经过rdb版本识别、db映射、大key拆分等一系列计算后写入目标集群。
* 全量同步结束后，任务进入命令传播模式，实时同步增量数据
* 应用停写
* 将所有应用切换到目标Redis。

### 回滚预案

* 准备备用回滚库
* 在业务停写后，切换流量以前启动从目标库到备用回滚库的增量同步任务
* 如果切量后发生系统异常，可将流量切回原库，利用备用库中的数据做数据补偿。

### 迁移时长15分钟

## 用户列表

* 180广告
* 汇桔网
* 9377游戏
* 银联
* 京东广告
* 人民日报
  

  ![二维码](../img/introduction/shiwenerweima.jpg)