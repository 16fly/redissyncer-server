# 跨云托管redis实时同步

### 场景描述
跨云托管redis是各个云厂商提供的redis服务，通常该类服务为用于提供vpc内可访问发uri用来访问数据同时屏蔽部署及运维细节。对于用户的好处是开箱即用，不必关注部署运维细节。
迁移场景中，通常云厂商通过上传rdb或aof文件同步线下或其他云上的redis。该方式只能同步全量数据，在数据同步过程中需要停服或者应用改为只读以保证数据一致。那么是否有方法实现跨云托管redis的实时同步呢？

### 难点和挑战
* 托管redis不能直接方法数据节点，故无法使用redis replicate协议实现增量同步
* 带宽限制，公网带宽不足造成延时以及网络瞬断造成任务失败
* 源与目标节点数量不一致时数据在节点间再分配问题
* 源与目标版本不一致时rdb文件兼容问题

### 方案
为了解决上述难点和挑战，实现跨云托管redis全量和增量同步，需要引入两类工具。一类工具是一种特殊的redis proxy，该代理的主要作用是redis入库数据在保证顺序的前提下分流；另一类工具提供redis rdb文件或aof文件的解析和写入。

![cloudredissync](../img/cloudredissync.png)

##### 数据复制流程

* 通过redis 写入流复制网关将更新数据写入kafka或rocketmq等消息队列做数据堆积
* 通过redissyncer同步rdb或aof存量数据
* redissyncer读取消息队列中的数据实现增量同步

##### redis流复制代理的实现难点
* 效率问题，通过代理必然带来吞吐量和延迟问题
* 如何保证数据顺序
  
  